<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Students - HostelHub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <aside class="sidebar"></aside>
    <main class="main-wrapper">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold mb-0">Student Management</h2>
            <button class="btn btn-premium" data-bs-toggle="modal" data-bs-target="#studentModal" onclick="prepareAdd()">
                <i class="bi bi-person-plus me-2"></i> Add New Student
            </button>
        </div>

        <div class="custom-table-card fade-in">
            <div class="p-4 border-bottom">
                <div class="row g-3">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-search text-muted"></i></span>
                            <input type="text" class="form-control border-start-0 bg-light" id="search-student" placeholder="Search by name, email or room...">
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Student Details</th>
                            <th>Room</th>
                            <th>Course</th>
                            <th>Fees</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="student-list">
                        <!-- Loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Student Modal -->
        <div class="modal fade" id="studentModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content border-0 shadow" style="border-radius: var(--radius);">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="fw-bold" id="modal-title">Add New Student</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="studentForm">
                        <input type="hidden" id="edit-id">
                        <div class="modal-body p-4">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="s-name" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="s-email" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="s-phone" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Course / Dept</label>
                                    <input type="text" class="form-control" id="s-course" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Room Number</label>
                                    <input type="text" class="form-control" id="s-room" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Fees Status</label>
                                    <select class="form-select" id="s-fees">
                                        <option value="Paid">Paid</option>
                                        <option value="Pending">Pending</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0 pt-0">
                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-premium px-4">Save Student</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const user = getCurrentUser();
            if (!user || user.role !== 'admin') { window.location.href = 'login.html'; return; }
            renderSidebar('Students', 'admin');
            renderTopNav(user.name);
            loadStudents();

            document.getElementById('search-student').addEventListener('input', loadStudents);

            document.getElementById('studentForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveStudent();
            });
        });

        function loadStudents() {
            const students = getData('students');
            const search = document.getElementById('search-student').value.toLowerCase();
            const list = document.getElementById('student-list');
            
            const filtered = students.filter(s => 
                s.name.toLowerCase().includes(search) || 
                s.email.toLowerCase().includes(search) || 
                s.roomNo.toLowerCase().includes(search)
            );

            list.innerHTML = filtered.map(s => `
                <tr>
                    <td>
                        <div class="fw-bold">${s.name}</div>
                        <div class="small text-muted">${s.email}</div>
                        <div class="small text-muted">${s.phone}</div>
                    </td>
                    <td><span class="fw-medium">${s.roomNo}</span></td>
                    <td>${s.course}</td>
                    <td><span class="badge badge-custom ${s.feesStatus === 'Paid' ? 'badge-success' : 'badge-danger'}">${s.feesStatus}</span></td>
                    <td>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-light border" onclick="editStudent(${s.id})"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-light border text-danger" onclick="deleteStudent(${s.id})"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function prepareAdd() {
            document.getElementById('modal-title').textContent = 'Add New Student';
            document.getElementById('edit-id').value = '';
            document.getElementById('studentForm').reset();
        }

        function editStudent(id) {
            const students = getData('students');
            const s = students.find(x => x.id == id);
            if (!s) return;

            document.getElementById('modal-title').textContent = 'Edit Student';
            document.getElementById('edit-id').value = s.id;
            document.getElementById('s-name').value = s.name;
            document.getElementById('s-email').value = s.email;
            document.getElementById('s-phone').value = s.phone;
            document.getElementById('s-course').value = s.course;
            document.getElementById('s-room').value = s.roomNo;
            document.getElementById('s-fees').value = s.feesStatus;

            new bootstrap.Modal(document.getElementById('studentModal')).show();
        }

        function saveStudent() {
            const students = getData('students');
            const id = document.getElementById('edit-id').value;
            
            const studentData = {
                name: document.getElementById('s-name').value,
                email: document.getElementById('s-email').value,
                phone: document.getElementById('s-phone').value,
                course: document.getElementById('s-course').value,
                roomNo: document.getElementById('s-room').value,
                feesStatus: document.getElementById('s-fees').value,
                attendance: 100 // Default for new
            };

            if (id) {
                const index = students.findIndex(s => s.id == id);
                students[index] = { ...students[index], ...studentData };
            } else {
                studentData.id = Date.now();
                students.push(studentData);
            }

            saveData('students', students);
            bootstrap.Modal.getInstance(document.getElementById('studentModal')).hide();
            loadStudents();
        }

        function deleteStudent(id) {
            if (confirm('Are you sure you want to delete this student?')) {
                const students = getData('students').filter(s => s.id != id);
                saveData('students', students);
                loadStudents();
            }
        }
    </script>
</body>
</html>
